<section class="mt-50 mb-50">
    <div class="container">
      

  
      <div class="row">
        <div class="col-md-6">
          <div class="mb-25">
            <h4>Select Your Address</h4>
          </div>
  
          <% 
          if(addresses.address.length==0) 
          {%><h2>No Addrerss added</h2><%}
          %>
  
  
  
            <form id="checkout-form" >
              <% addresses.address.forEach((address)=> { %>
                <div>
                  <div class="payment_option">
  
                    <div class="custome-radio"
                      style="width: 35rem; height: 13rem;background-color: whitesmoke; padding: 20px; border-radius: 30px;">
  
  
                      <input type="radio" id="address1" name="address" value="<%=address._id%>" checked style="height: 10px;width:10px;">
  
                      <h4>
                        <%=address.name%>
                      </h4>
  
                      <h5>
                        <%=address.lastName%>
                        </h5>
                      </h6><%=address.firstLine%>
                              </h6>
                              <h5>
                                <%=address.SecondLine%>
                              </h5>
                              <h5>
                                <%=address.city%>
                              </h5>
                              <h5>
                                <%=address.state%>
                              </h5>
                              <h5>
                                <%=address.pincode%>
                              </h5>
                              <h5>
                                <%=address.mobile%>
                              </h5>
  
                              <br>
                    </div>
  
                  </div>
  
  
                </div>
                <% } )%>
                <div style="width: 35rem; height: 3rem;background-color: whitesmoke; padding: 20px;">
              <a href="/userprofileaddress">
                <h5>+ Add an address</h5>
              </a>
  
            </div>
  
                  <div class="payment_method">
                    <p>Payment Method</p>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="paymentMethod" value="COD" checked>
                      <label class="form-check-label" for="flexRadioDefault1">
                        COD
                      </label>
                    </div>
  
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="paymentMethod" value="razorpay">
                      <label class="form-check-label" for="flexRadioDefault1">
                        Razorpay
                      </label>
                    </div>
  
               
  
                
  
  
  
  
  
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="paymentMethod" value="wallet">
                      <label class="form-check-label" for="flexRadioDefault1">
                        wallet
                      </label>
                    </div>
                    <div class="form-group">
  
  
                    </div>
                  </div>
                  <button type="submit">Place Order</button>
                  
                  
            </form>
  
  
  
  
  
            <br>
  
  
  
            <br>
            
  
  
        </div>
  
  
        <div class="col-md-6">
          <div class="order_review">
            <div class="mb-20">
              <h4>Your Orders</h4>
            </div>
            <div class="table-responsive order_table text-center">
              <table class="table">
                <thead>
                  <tr>
                    <th colspan="2">Product</th>
                    <th>Price</th>
                  </tr>
                </thead>
  
                <tbody>
                  <% cart.forEach((cartitems)=> { %>
  
                    <tr>
  
                      
                      <td class="image product-thumbnail" style="height: 30px; width: 20;"><img src="/images/products/<%=cartitems.products[0]?.Image[0]%>"></td>
                      <td>
  
                        <h5><a href="shop-product-full.html"></a></h5> <span class="product-qty">
                          <%=cartitems.quantity%>
                        </span>
                        
                      </td>
                      <td>₹<%=cartitems.subtotal%></td>
                      <td> <span class="product-qty"><%=cartitems.Price%></span></td>
  
                    </tr>
                   
  
                    <tr>
                          
                      </tr>
                      <% } )%>
  
                    <tr>
                      <th>Shipping</th>
                      <td colspan="2"><em>Free Shipping</em></td>
                    </tr>
                    <tr>
                      <th>Your Special Offer</th>
                      <%let discount=cartTotal-offerprice%>
                      <td colspan="2"><em id="couponOffer">-<%=discount%></em></td>
                    </tr>
                    
                    <% if (offerprice) { %>
  .
  <tr>
                      
                      <th>Total</th>
                      
                      <td colspan="2" class="product-subtotal"><span class="font-xl text-brand fw-900" id="total">₹
                        <%=offerprice%>
                        
                        </span>
                      </td>
  
                    </tr>
                     <% } else { %>
                      <tr>
                      
                      <th>Total</th>
                      
                      <td colspan="2" class="product-subtotal"><span class="font-xl text-brand fw-900" id="total">₹
                        <%=cartTotal%>
                        
                        </span>
                      </td>
  
                    </tr>
                       
                     <% } %>
                    
                </tbody>
              </table>
            </div>
            
  
  
          </div>
        </form>
          
      </div>
    </div>
    <div class="m-5">
      <div class="heading_s1 mb-3">
        <h4>Apply Coupon</h4>
      </div>
      <div class="total-amount">
        <div class="left">
          <div class="coupon">
  
  
            <form action="/applycoupon" method="post" id="couponform">
              <div class="form-row row justify-content-center">
                <div class="form-group col-lg-6">
                  <input type="text" class="form-control" autocomplete="off" required id="code"
                    placeholder="coupon code" name="code" />
                </div>
                <div class="form-group col-lg-6">
                  <button class="btn btn-sm btn-outline-primary bg-light" style="width: 3em; height: 3em" type="submit">
                    <i class="icon-long-arrow-right"></i>
                  </button>
                </div>
              </div>
            </form>
  
            
            <span class="couponErr"></span>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  
  <script>

  
    $('#checkout-form').submit((e) => {
      e.preventDefault();
      console.log("jj");
      $.ajax({
        url: '/place-order',
        method: 'post',
        data: $('#checkout-form').serialize(),
        success: (response) => {console.log(response)

          if (response.COD == true) {
            location.href = '/ordersuccess';
          }else{
            RazorPay(response)
          }
        },
      });
    });
   
  
  
  
  
  
  
  
  
  function RazorPay(order){
    console.log(order.id ,'dfjdfhdghfkdh')
    var options = {
      "key": "rzp_test_E6MNPnyr0tBqss", // Enter the Key ID generated from the Dashboard
      "amount": Number(order.amount), // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise,
      "currency": "INR",
      "name": "EUROSPORTS",
      "description": "Test Transaction",
      "image": "https://example.com/your_logo",
      "order_id": order.id, //This is a sample Order ID. Pass the id obtained in the response of Step 1
      "handler": function (response) {
        // alert(response.razorpay_payment_id);
        // alert(response.razorpay_order_id);
        // alert(response.razorpay_signature)
        verifypayment(response, order)
      },
      "prefill": {
        "name": "Gaurav Kumar",
        "email": "gaurav.kumar@example.com",
        "contact": "9999999999"
      },
      "notes": {
        "address": "Razorpay Corporate Office"
      },
      "theme": {
        "color": "#3399cc"
      }
    };
    var rzp1 = new Razorpay(options)
    rzp1.open();
    }

    function verifypayment(payment, order) {
    $.ajax({


      url: '/verify_payment',
      data: {
        payment,
        order
      },
      method: 'post',
      success: (response) => {
        console.log(response,'jhdfjdfhfdf')
        if (response.status) {
          location.href = '/ordersuccess';
        } 

      }
    })
  }
  
  
  
  
  
  
  </script>